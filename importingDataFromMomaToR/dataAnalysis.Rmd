---
title: "dataAnalysis"
author: "Dany Chauvin"
date: "12/14/2020"
output: html_document
---

This is supposed to be a generic script for mother machine data analysis in Rstudio.

# Importing packages, functions and data

Restart R at this point.

```{r}
path_to_data_summary <- "/scicore/home/nimwegen/rocasu25/Documents/Projects/biozentrum/mothermachine_scripts/importingDataFromMomaToR/constitexprData.csv"
#Calling functions and packages
source("/scicore/home/nimwegen/rocasu25/Documents/Projects/biozentrum/mothermachine_scripts/importingDataFromMomaToR/loadFunctionsAndPackages.R")
#Import data
source("/scicore/home/nimwegen/rocasu25/Documents/Projects/biozentrum/mothermachine_scripts/importingDataFromMomaToR/deepMomaToDf.R")
```
# Setting strains

In multiplex experiments, different growth lanes might have different strains, characterized by different fluorescence backgrounds. The identity of these strains have to be attached to myframes_to_mycells and mycells. This can be attached to the data using .csv files or directly here.

```{r}
myframes_to_mycells <- myframes_to_mycells %>% 
   mutate(strain='MG1655')
```
# Converting GFP units

Depending on the strain, fluorescence signal has to be converted to GFP numbers with different conversion factors.

```{r}
myframes_to_mycells <- myframes_to_mycells %>%
  # append relevant conversion parameters
  mutate(autofluo_predict=NA, fp_per_dn=NA,
         # case of GFPmut2 (from zaslaver library)
         autofluo_predict = ifelse(strain!='asc662', 133.6, autofluo_predict),
         fp_per_dn = ifelse(strain!='asc662', 0.198, fp_per_dn),
         # case of asc662
         autofluo_predict = ifelse(strain=='asc662', 422.8, autofluo_predict),
         fp_per_dn = ifelse(strain=='asc662', 0.0361 * 4, fp_per_dn)) %>% 
  # convert to gfp units (after subtracting autofluorescence)
  mutate(fluogfp_amplitude = fluo_amplitude - autofluo_predict * length_um,
         gfp_nb = fluogfp_amplitude * fp_per_dn ) %>% 
  group_by(cell) %>% 
  arrange(time_sec) %>% 
  mutate(g_birth=first(gfp_nb)) %>% 
  mutate(g_div=last(gfp_nb))

cell_fluo_info <- myframes_to_mycells %>% 
  distinct(cell,g_birth,g_div)
```

# Propagating fluorescence information to full cell cycle

```{r}
mycells <- mycells %>% 
  left_join(cell_fluo_info,by=c("cell")) %>% 
  mutate(c_birth=g_birth/l_birth,
         c_div=g_div/l_div,
         dg=g_div - g_birth,
         dcdt=(g_div/l_div - g_birth/l_birth) / div_time,
         g=log(g_div/g_birth) / div_time, # would be cleaner from a fit but difficult to compare
         gamma=dg/dl,
         q=dg/dl*alpha)

# Change factor values

mycells$condition <- factor(mycells$condition,levels=c("acetate","glycerol","glucose","glucoseaa"))
myframes_to_mycells$condition <- factor(myframes_to_mycells$condition,levels=c("acetate","glycerol","glucose","glucoseaa"))
myframes_to_mycells$promoter <- factor(myframes_to_mycells$promoter,levels=c("hi1","hi3","med2","med3","rplN","rpmB","rpsB","rrnB"))
```

# Analysis

## Integrated variables

Instantaneous measurements of cell phenotype is noisy. A first goal of this work is to derive integrated quantities which are not likely to be sensitive to noise measurements.

Such "robust" quantities are:

- The average exponential growth rate: $\alpha$
- The mean GFP concentration $<c>=<GFP(t)/l(t)>_{promoter}$
- The average GFP volumic production $<Q(t)>_t=<\frac{1}{l(t)}\frac{dGFP(t)}{dt}>_t$

The value $\frac{dGFP(t)}{dt}$ is not reachable without a proper noise model. Another approach is to integrate the following equation:

(1) $$\frac{d[GFP](t)}{dt}=Q(t)-\frac{[GFP](t)}{l(t)}\frac{dl(t)}{dt}$$
(2) $$<Q(t)>=<\frac{d[GFP](t)}{dt}+\frac{[GFP](t)}{l(t)}\frac{dl(t)}{dt}>$$
(3) $$<Q(t)>=<\frac{d[GFP](t)}{dt}>+<\frac{[GFP](t)}{l(t)}\frac{dl(t)}{dt}>$$
(3) $$<Q(t)>=<\frac{d[GFP](t)}{dt}>+<\frac{[GFP](t)}{l(t)}\frac{dl(t)}{dt}>$$

Assuming that on first approximation $\alpha=\frac{1}{l(t)}\frac{dl(t)}{dt}$ is constant (only interested in order 0 terms).

(4) $$<Q(t)>=<\frac{d[GFP](t)}{dt}>+<[GFP](t)>\alpha$$

And

$<\frac{d[GFP](t)}{dt}>$ can be computed from a crude estimation: difference between consecutive data points.

## Time correlation between these variables

A natural way to think about this variables is to think of the correlation they present between mother and daughter.
But is is also possible to look at what's happening between the first half of the cell cycle and the second part of the cell cycle.

## Notes about instantaneous variables and fluctuations in general

To be completed:

The quantity that looks to be, according to me the most important to looks at are to look at two daughters cells:

(5) $$\frac{d[GFP](t)}{dt}=Q(t)-\frac{[GFP](t)}{l(t)}\frac{dl(t)}{dt}$$

Leads to by integration

(6) $$\Delta[GFP]=\int_{t_0}^{t}(Q(t')dt')-\int_{t_0}^{t}(\frac{[GFP](t')}{l(t')}\frac{dl(t')}{dt'}dt'$$ Change in $[GFP]$ between $t_0$ and $t$.


The question being: what is driving the phenotypic heterogeneity is therefore to understand, from a time point t0 where the cells are characterized by identical concentration (we suppose here that the concentration is equal in two daughter cells immediately after division): which term is going to cause most of the difference between them: the growth rate fluctuation term? Or the production term? One has to compute:

(7) $$ \Delta\Delta[GFP]_{i,j} $$

Where $i$ and $j$ are different cells.
One question that someone might already ask is: how long two cells have to grow so that their concentration diverge enough to be noticeable.
Is this time different between promoters? This can be performed by concatenating cell cycles.

And see how these term diverge with times, for two independent processes. My guess is that if these are controlled by processes with identical parameters, they will not diverge to the infinite.

$P(t)=\int_{t_0}^{t}(Q(t')dt')$
$D(t)=\int_{t_0}^{t}(\frac{[GFP](t')}{l(t')}\frac{dl(t')}{dt'}dt'$

# Distribution of growth rates

```{r}
mycells %>% 
  ggplot(aes(alpha*3600/log(2),col=date))+
  stat_ecdf()+
  facet_wrap(~condition,scales="free")+
  theme_cowplot()+
  xlab("Doublings per hour")+
  ylab("CDF")
```

```{r}
mycells %>% 
  ggplot(aes(alpha*3600/log(2),col=condition))+
  stat_ecdf()+
  theme_cowplot()+
  xlab("Doublings per hour")+
  ylab("CDF")
```

# Computing mean values of Q

We want to get to: $$<Q(t)>=<\frac{d[GFP](t)}{dt}>+<[GFP](t)>\alpha$$
First will compute in myframes for each cell: $dgdt=(gfp_nb(t+t_interval)-gfp_nb(t))/t_interval$

```{r}
mycells_alpha <- mycells %>% 
  distinct(cell,alpha)

myframes_analysis <- myframes_to_mycells %>% 
  left_join(mycells_alpha,by=c("cell")) %>% 
  group_by(cell) %>% 
  mutate(lag_gfp_nb=lag(gfp_nb),
         lag_length_um=lag(length_um),
         dg=gfp_nb-lag_gfp_nb,
         dgdt=dg/t_interval,
         q=dgdt*1/length_um,
         dldt=(length_um-lag_length_um)/t_interval,
         d=1/length_um*dldt,
         c=gfp_nb/length_um,
         dc=gfp_nb/length_um-lag_gfp_nb/lag_length_um,
         dcdt=dc/t_interval) %>%
  mutate(mean_q=mean(q,na.rm=TRUE),
         mean_d=mean(d,na.rm=TRUE),
         mean_c=mean(c,na.rm=TRUE),
         ratio_q_d=mean_q/mean_d) %>% 
  ungroup() %>% 
  mutate(mean_mean_q=mean(mean_q,na.rm=TRUE),
         mean_mean_d=mean(mean_d,na.rm=TRUE),
         mean_mean_c=mean(mean_c,na.rm=TRUE),
         mean_ratio_q_d=mean(ratio_q_d,na.rm=TRUE))
```

Visualize data in each condition. Scatter plot

```{r}
myframes_analysis %>% 
  distinct(cell,.keep_all=TRUE) %>% 
  ggplot(aes(condition,log(mean_d)))+
  geom_boxplot()+
  geom_jitter(alpha=0.05)+
  #facet_wrap(~promoter,scales="free")+
  xlab("Condition")+
  ylab("log(<D>)")+
  theme_cowplot()

myframes_analysis %>% 
  distinct(cell,.keep_all=TRUE) %>% 
  ggplot(aes(condition,log(mean_q)))+
  geom_boxplot()+
  geom_jitter(alpha=0.1)+
  facet_wrap(~promoter,scales="free")+
  xlab("Condition")+
  ylab("log(<Q>)")+
  theme_cowplot()

myframes_analysis %>% 
  distinct(cell,.keep_all=TRUE) %>% 
  ggplot(aes(condition,log(mean_c)))+
  geom_boxplot()+
  geom_jitter(alpha=0.05)+
  facet_wrap(~promoter,scales="free")+
  xlab("Condition")+
  ylab("log(<[GFP]>)")+
  theme_cowplot()
```
```{r}
myframes_analysis %>% 
  distinct(cell,.keep_all=TRUE) %>% 
  ggplot(aes(condition,log(ratio_q_d)))+
  geom_boxplot()+
  geom_jitter(alpha=0.05)+
  facet_wrap(~promoter,scales="free")+
  xlab("Condition")+
  ylab("log(<Q>/<D>)")+
  theme_cowplot()
```

This shows, without the need of any fit, that, the overall trend is that ribosomal promoters compensate for increasing dilution factor, with enhanced production. This is what is causing the differences we observe in terms of GFP concentration. This method seems to be robust versus experimental measurements.

Now, I would like to understand on average, what seems to be responsible for typical observed differences between daughters cells that have similar concentrations at the beginning of their cell cycles.

For that, I first need to compute list of daughter cells in each condition, and then to compute their difference in concentration over time. 

```{r}
daughters <- myframes_daughters_compute(myframes_to_mycells)
condition_df <- myframes_to_mycells %>% 
  distinct(cell,condition,promoter) %>% 
  rename(daughter_1=cell)

daughters %>%
  left_join(condition_df,by=c("daughter_1")) %>% 
  group_by(trace_id) %>%
  mutate(time=time_sec-first(time_sec)) %>% 
  ungroup() %>% 
  ggplot()+
  geom_line(aes(time,abs(delta_c),group=trace_id))+
  facet_grid(promoter~condition,scales="free")
```

```{r}
daughters %>%
  left_join(condition_df,by=c("daughter_1")) %>% 
  group_by(trace_id) %>%
  mutate(time=time_sec-first(time_sec)) %>% 
  ungroup() %>% 
  group_by(condition,promoter,time) %>% 
  mutate(mean_delta_c=mean(abs(delta_c),na.rm=TRUE)) %>% 
  ungroup() %>% 
  distinct(condition,promoter,time,mean_delta_c) %>% 
  ggplot()+
  geom_line(aes(time,log(mean_delta_c)))+
  facet_grid(promoter~condition,scales="free")+
  theme_cowplot()
```
Overall this is not as nice and as simple as I thought. It seems that daughter cells have very different concentration at birth...

```{r}
first_concentration_1 <- myframes_analysis %>% 
  group_by(cell) %>% 
  arrange(time_sec) %>% 
  filter(row_number()==1) %>% 
  ungroup() %>%
  mutate(daughter_1=cell,
         daughter_2=cell) %>% 
  rename(c_first_1=c) %>% 
  select(daughter_1,c_first_1) 
  
first_concentration_2 <- first_concentration_1 %>% 
  rename(daughter_2=daughter_1) %>% 
  rename(c_first_2=c_first_1)

daughters %>%
  left_join(condition_df,by=c("daughter_1")) %>% 
  distinct(trace_id,daughter_1,daughter_2,promoter,condition) %>% 
  left_join(first_concentration_1,by=c("daughter_1")) %>%
  left_join(first_concentration_2,by=c("daughter_2")) %>% 
  ggplot(aes(log(c_first_1),log(c_first_2)))+
  geom_point()+
  facet_wrap(~promoter + condition,scales="free")+
  theme_cowplot()+
  xlab("Concentration daughter 1")+
  ylab("Concentration daughter 2")
```
```{r}
first_concentration_1 <- myframes_analysis %>% 
  group_by(cell) %>% 
  arrange(time_sec) %>% 
  filter(row_number()==1) %>% 
  ungroup() %>%
  mutate(daughter_1=cell,
         daughter_2=cell) %>% 
  rename(c_first_1=c) %>% 
  select(daughter_1,c_first_1) 
  
first_concentration_2 <- first_concentration_1 %>% 
  rename(daughter_2=daughter_1) %>% 
  rename(c_first_2=c_first_1)

daughters %>%
  left_join(condition_df,by=c("daughter_1")) %>% 
  distinct(trace_id,daughter_1,daughter_2,promoter,condition) %>% 
  left_join(first_concentration_1,by=c("daughter_1")) %>%
  left_join(first_concentration_2,by=c("daughter_2")) %>% 
  mutate(cond_prom=paste(condition,promoter,sep=".")) %>% 
  ggplot(aes(c_first_1,c_first_2))+
  geom_point()+
  facet_wrap(~cond_prom,scales="free")+
  theme_cowplot()+
  xlab("Concentration daughter 1")+
  ylab("Concentration daughter 2")
```
So clearly, concentration between sisters is maintained.
Is it also the case for sisters 10 points later?

```{r}
first_concentration_1 <- myframes_analysis %>% 
  group_by(cell) %>% 
  arrange(time_sec) %>% 
  filter(row_number()==20) %>% 
  ungroup() %>%
  mutate(daughter_1=cell,
         daughter_2=cell) %>% 
  rename(c_first_1=c) %>% 
  select(daughter_1,c_first_1) 
  
first_concentration_2 <- first_concentration_1 %>% 
  rename(daughter_2=daughter_1) %>% 
  rename(c_first_2=c_first_1)

daughters %>%
  left_join(condition_df,by=c("daughter_1")) %>% 
  distinct(trace_id,daughter_1,daughter_2,promoter,condition) %>% 
  left_join(first_concentration_1,by=c("daughter_1")) %>%
  left_join(first_concentration_2,by=c("daughter_2")) %>% 
  mutate(cond_prom=paste(condition,promoter,sep=".")) %>% 
  ggplot(aes(c_first_1,c_first_2))+
  geom_point()+
  facet_wrap(~cond_prom,scales="free")+
  theme_cowplot()+
  xlab("Concentration daughter 1")+
  ylab("Concentration daughter 2")
```
```{r}
first_concentration_1 <- myframes_analysis %>% 
  group_by(cell) %>% 
  arrange(time_sec) %>% 
  filter(row_number()==30) %>% 
  ungroup() %>%
  mutate(daughter_1=cell,
         daughter_2=cell) %>% 
  rename(c_first_1=c) %>% 
  select(daughter_1,c_first_1) 
  
first_concentration_2 <- first_concentration_1 %>% 
  rename(daughter_2=daughter_1) %>% 
  rename(c_first_2=c_first_1)

daughters %>%
  left_join(condition_df,by=c("daughter_1")) %>% 
  distinct(trace_id,daughter_1,daughter_2,promoter,condition) %>% 
  left_join(first_concentration_1,by=c("daughter_1")) %>%
  left_join(first_concentration_2,by=c("daughter_2")) %>% 
  mutate(cond_prom=paste(condition,promoter,sep=".")) %>% 
  ggplot(aes(c_first_1,c_first_2))+
  geom_point()+
  facet_wrap(~cond_prom,scales="free")+
  theme_cowplot()+
  xlab("Concentration daughter 1")+
  ylab("Concentration daughter 2")
```

Test scrambling the data:

```{r}
first_concentration_1 <- myframes_analysis %>% 
  group_by(cell) %>% 
  arrange(time_sec) %>% 
  filter(row_number()==round(runif(1, 1, 20),0)) %>% 
  ungroup() %>%
  mutate(daughter_1=cell,
         daughter_2=cell) %>% 
  rename(c_first_1=c) %>% 
  select(daughter_1,c_first_1) 
  
first_concentration_2 <- first_concentration_1 %>% 
  rename(daughter_2=daughter_1) %>% 
  rename(c_first_2=c_first_1)

daughters %>%
  left_join(condition_df,by=c("daughter_1")) %>% 
  distinct(trace_id,daughter_1,daughter_2,promoter,condition) %>% 
  left_join(first_concentration_1,by=c("daughter_1")) %>%
  left_join(first_concentration_2,by=c("daughter_2")) %>% 
  mutate(cond_prom=paste(condition,promoter,sep=".")) %>% 
  ggplot(aes(c_first_1,c_first_2))+
  geom_point()+
  facet_wrap(~cond_prom,scales="free")+
  theme_cowplot()+
  xlab("Concentration daughter 1")+
  ylab("Concentration daughter 2")
```
It is clear that sister cells have, all along their cell cycle, high correlation in their concentration.
So I need to look further. Typically after one division.

```{r}
library(magrittr)

daughters_mothers <- myframes_mother_daughters_compute(myframes_to_mycells)

parent_df <- myframes_to_mycells %>% 
  mutate(parent=paste(date,pos,orientation,gl,parent_id,sep=".")) %>%
  distinct(cell,parent)

daughters_mothers <- daughters_mothers %>% 
  rename(cell=trace_id) %>% 
  left_join(parent_df,by=c("cell"))

daughters_mothers_2 <- daughters_mothers %>% 
  filter(parent=="20190515.0.b.12.103") %>% 
  mutate(c=gfp_nb/length_um) %>% 
  group_by(parent) %>%
  nest(type,time_sec,length_um,gfp_nb,c,.key='value_col') %>% 
  spread(key=cell,value=value_col) %>% 
  set_colnames(c("description", "condition","parent","cell1","cell2")) %>% 
  unnest(cell1,cell2,.sep='_')

daughters_mothers_2 <- daughters_mothers %>% 
  #filter(parent=="20190515.0.b.12.103") %>% 
  group_by(parent) %>%
  filter(length(unique(.$cell))==2) %>% 
  pivot_wider(
    names_from=cell,
    values_from=c(type,length_um,gfp_nb),
    values_fill=NA) %>%
  set_colnames(c("description", "condition", "time_sec","parent","type_1","type_2","length_um_1","length_um_2","gfp_nb_1","gfp_nb_2")) %>% 
  drop_na() %>% 
  ungroup()
```



